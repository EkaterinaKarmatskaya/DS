import pandas as pd
import numpy as np

df_full = pd.read_csv("df_full.csv")
# После импорта из CSV востанавливаем формат колонки с датой
df_full["payment_date"] = pd.to_datetime(df_full["payment_date"], errors="raise")

# Определение для недели 1 — рабочий день , 0 — выходной
df_full["is_workday"] = df_full["payment_date"].dt.weekday.apply(
    lambda x: 1 if x < 5 else 0
)

# Колонки датафрейма ранее были отсортированы по дате для создания лага
lags = [30, 61, 91]
for lag in lags:
    df_full[f"lag_{lag}"] = df_full["volume"].shift(lag)

# Замена Nan на значение
df_full = df_full.fillna(0)


# Создаем экспоненциально взвешенное скользящее среднее (EWM) с окнами размером 7, 30 и 91 день
ewm_windows = [7, 30, 91]
for window in ewm_windows:
    df_full[f"ewm_{window}"] = df_full["volume"].ewm(span=window, adjust=False).mean()

"""span=window задаёт «окно» в терминах экспоненциального взвешивания. 
"Это определяет коэффициент сглаживания α = 2 / (span + 1)."""


print(df_full)

# Выгрузка датафрейма в CSV для дальнейшей с ним работы
df_full.to_csv("df_full_lag_ewm.csv")
